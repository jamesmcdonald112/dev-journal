# **Sentry for Astro — Final Notes (Correct & Minimal)**

  

**Docs:** https://docs.sentry.io/platforms/javascript/guides/astro/

---

# **1. Install Sentry**

```
npx astro add @sentry/astro
```

This:

- installs @sentry/astro
    
- adds sentry() to astro.config.ts
    
- does **not** create config files → you must create them
    

---

# **2. Required Sentry Files (You MUST have both)**

  

Create these **in the project root**:

```
sentry.client.config.js
sentry.server.config.js
```

|**File**|**Runs In**|**Purpose**|
|---|---|---|
|sentry.client.config.js|Browser|Catch frontend errors|
|sentry.server.config.js|Server / SSR|Catch backend errors|

Astro has **two runtimes**, so Sentry must be initialized twice.

---

# **3. Client SDK — sentry.client.config.js**

```js
import * as Sentry from "@sentry/astro";

Sentry.init({
  dsn: import.meta.env.PUBLIC_SENTRY_DSN,

  sendDefaultPii: false,
  tracesSampleRate: 0,
  replaysSessionSampleRate: 0,
  replaysOnErrorSampleRate: 0,
});
```

---

# **4. Server SDK — sentry.server.config.js**

```js
import * as Sentry from "@sentry/astro";

Sentry.init({
  dsn: import.meta.env.PUBLIC_SENTRY_DSN,

  sendDefaultPii: false,
  tracesSampleRate: 0,
});
```

---

# **5. astro.config.ts — Minimal + Correct**

  

You already added this, but this is the correct minimal version:

```ts
import { defineConfig } from "astro/config";
import sentry from "@sentry/astro";
import react from "@astrojs/react";
import tailwindcss from "@tailwindcss/vite";
import vercel from "@astrojs/vercel";

export default defineConfig({
  output: "server",
  adapter: vercel(),
  vite: { plugins: [tailwindcss()] },
  integrations: [react(), sentry()],
});
```

**Important:**

✔ No DSN here

✔ No auth token here

✔ No org/project here

Those belong in the config files + Vercel env vars only.

---

# **6. Environment Variables (Vercel)**

  

You must add **both** to Vercel:

  

### **1. PUBLIC_SENTRY_DSN**

  

From your Sentry project page → “Client Keys (DSN)”

  

Example:

```
PUBLIC_SENTRY_DSN=https://xxxx.ingest.de.sentry.io/yyyy
```

### **2. SENTRY_AUTH_TOKEN**

  

Used _only for sourcemap uploads during Vercel builds_

Never exposed to browser.

  

Your token:

```
SENTRY_AUTH_TOKEN=sntrys_xxxxxxxxxxxxx
```

---

# **7. Why You Need Both Variables**

|**Variable**|**Used Where?**|**Purpose**|
|---|---|---|
|**PUBLIC_SENTRY_DSN**|client + server|Connects the SDK to your Sentry project|
|**SENTRY_AUTH_TOKEN**|_Vercel build machine only_|Uploads source maps → readable stack traces|

---

# **8. Testing Sentry**

  

Add this to any Astro page:

```html
<button onclick="throw new Error('Test Astro Error')">Test Error</button>
```

Run:

```bash
npm run dev
```

Click → check Sentry dashboard.

---

## **9. Optional: Environment & Release (Client-Safe)**

  

If you want to explicitly set **environment** or **release**, they must follow the same rules as the DSN.

  

**Important rule:**

Anything used in sentry.client.config.js must be **browser-safe** and prefixed with PUBLIC_.

---

### **Environment variables**

```env
PUBLIC_SENTRY_ENVIRONMENT=production
PUBLIC_SENTRY_RELEASE=1.0.0
```

These are safe to expose because they contain **no secrets**.

---

### **Client config**

```js
import * as Sentry from "@sentry/astro";

Sentry.init({
  dsn: import.meta.env.PUBLIC_SENTRY_DSN,

  environment: import.meta.env.PUBLIC_SENTRY_ENVIRONMENT,
  release: import.meta.env.PUBLIC_SENTRY_RELEASE,

  sendDefaultPii: false,
  tracesSampleRate: 0,
});
```

---

### **Notes**

- Do **not** use process.env in client config
    
- Do **not** expose secrets (auth tokens) to the browser
    
- This section is optional — Sentry works fine without it
    

### **10. Production verification (what “working” actually means)**

  

Sentry is “working” when ALL of these are true:

- ✅ **Client errors arrive** (browser JS errors)
    
- ✅ **Server errors arrive** (Astro API routes / server actions)
    
- ✅ **Source maps upload** (stack traces readable in production)
    

  

### **11. How to test in production safely**

  

#### **Client test**

1. Temporarily add a test button (remove after):
    

```
<button
  type="button"
  onClick={() => {
    throw new Error("Sentry client test");
  }}
>
  Sentry client test
</button>
```

2. Deploy
    
3. Click once → confirm issue appears in Sentry → remove button → deploy again
    

  

#### **Server test (admin-protected API route)**

Create an endpoint like:

/src/pages/api/sentry-server-test.ts

  

Key points:

- Protect it with an **admin token header**
    
- Always return new Response(...)
    
- await Sentry.flush() before returning (serverless can exit fast)
    

  

Example curl:

```
curl -i https://www.musicschoolsites.com/api/sentry-server-test \
  -H "x-admin-token: <ADMIN_TEST_TOKEN>"
```

### **12. Admin token gotcha (why you got 403 earlier)**

  

Tokens copied from dashboards often include hidden whitespace/newlines.

  

Fix in code:

- import.meta.env.ADMIN_TEST_TOKEN?.trim()
    
- request.headers.get("x-admin-token")?.trim()
    

  

If you see:

- 401 → you forgot the header
    
- 403 → header exists but value doesn’t match
    
- 200 → endpoint ran + Sentry captured
    

  

### **13. What to do with test issues in Sentry**

- Add comment: “Intentional test error for setup verification.”
    
- Mark as **Resolved** (don’t ignore forever unless you want to hide future real errors with same grouping)
    

  

### **14. Keep or remove the server test route?**

- **Keep** it, but lock it down (admin header + no-store).
    
- If you don’t want it in prod, delete it after verification.
    

---
