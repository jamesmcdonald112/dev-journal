### **Why we’re doing it**

- **Stops cross-site form abuse**: another site can’t spam your action from the browser.
    
- **Cheap hardening**: no Redis/KV, no third-party service, minimal code.
    
- **Reduces noise**: fewer bot submissions reaching your email service.
    

---

## **Steps (implementation)**

  

### **1) Decide your allowed origins**

  

**TODO**

- List the domains that are allowed to submit the form:
    
    - http://localhost:4321 (dev)
        
    - https://your-prod-domain (prod)
        
    - optionally https://www.your-prod-domain
        
    

  

**Why**

- This is your allowlist. Everything else gets blocked.
    

---

### **2) Add env variable(s)**

  

**TODO**

- Add an env var like:
    
    - ALLOWED_ORIGINS=http://localhost:4321,https://yoursite.ie,https://www.yoursite.ie
        
    

  

**Why**

- Keeps code generic. No hardcoding domains in source.
    

---

### **3) Implement a small helper:** 

### **isAllowedOrigin(headers)**

  

**TODO**

- Read Origin header first.
    
- If missing, read Referer and extract the origin.
    
- Compare to your allowlist.
    

  

**Why**

- Some requests won’t include Origin consistently; Referer is a useful fallback.
    

---

### **4) Enforce it in the action handler (before doing work)**

  

**TODO**

- At the start of sendInfoPackHandler, before honeypot + email:
    
    - If origin not allowed → **throw ActionError** with code FORBIDDEN (or return a 403-style error you already use).
        
    

  

**Why**

- Blocks bad requests early. Saves cost. Keeps the rest of the logic unchanged.
    

---

### **5) Decide “fail open” vs “fail closed”**

  

**TODO**

- Default: **fail closed** (block if you can’t determine origin or allowlist misconfigured).
    
- Optional: In dev only, allow if env missing.
    

  

**Why**

- Security only works if unknowns don’t slip through. But dev should remain usable.
    

---

## **Steps (tests)**

  

### **6) Add tests in** 

### **sendInfoPack.test.ts**

  

**TODO**

- “Allows valid origin” test:
    
    - Call handler with mocked headers/or request context (depends how your handler receives request).
        
    - Expect email service called.
        
    
- “Rejects invalid origin” test:
    
    - Origin = https://evil.com
        
    - Expect ActionError with forbidden code.
        
    - Expect email service NOT called.
        
    
- “Rejects missing origin” test (optional but recommended):
    
    - No Origin/Referer
        
    - Expect forbidden.
        
    

  

**Why**

- Prevents regressions and proves you’re actually blocking cross-site submissions.
    

---

## **Steps (ops / logging)**

  

### **7) Logging policy**

  

**TODO**

- Do **not** send origin-block events to Sentry by default.
    
- Optional: console.log only in dev when debugging.
    

  

**Why**

- Blocks will be frequent internet noise and will cost you in logs/alerts.
    

---

## **Definition of done (checklist)**

- ALLOWED_ORIGINS added locally + in Vercel env
    
- Origin validation blocks invalid origins **before** calling email service
    
- Unit tests cover allow + block
    
- No Sentry spam from blocked origins
    
