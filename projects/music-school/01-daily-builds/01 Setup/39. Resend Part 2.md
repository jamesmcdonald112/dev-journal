### **Goal**

  

Send an **internal notification email** to the site owner when someone submits the “Info Pack” form — safely, configurable per client/site, and testable.

---

## **What we built**

  

### **1) A single “service” function that sends the email**

  

**File:** src/features/InfoPack/service/deliverInfoPack.ts

  

This function is called by the Astro Action handler (so the Action controls security/validation, and the service only handles “send email”).

  

**Why this structure**

- Keeps **side effects** (email sending) in one place.
    
- Makes it **easy to test** without involving Astro Actions.
    
- Makes it reusable across multiple forms/projects.
    

---

## **Key decisions inside** 

## **deliverInfoPack**

  

### **A) Configurable email routing via env vars**

  

Instead of hardcoding addresses, we read:

- RESEND_API_KEY (required)
    
- INFO_PACK_TO_EMAIL (required; supports comma list)
    
- INFO_PACK_FROM (optional; default provided)
    
- INFO_PACK_REPLY_TO (optional fallback)
    

  

**Why**

- Every client/site needs different “to/from/reply-to”
    
- Keeps secrets out of git
    
- No code change required when cloning for a new client (just env vars)
    

---

### **B)** 

### **replyTo**

###  **points at the lead (the person who filled the form)**

```
replyTo: input.email (fallback to INFO_PACK_REPLY_TO)
```

**Why**

- When you receive the notification and hit “Reply”, it should go to the lead directly.
    
- The fallback exists in case the user’s email is blank (or validation changes later).
    

---

### **C) HTML escaping prevents email HTML/script injection**

  

We escape all user-controlled fields before inserting into HTML:

- fullName
    
- email
    
- phone
    
- studentAge
    
- message
    

  

**Why**

If someone submits something like:

```
<script>alert(1)</script>
```

and you inject it into the email HTML without escaping, it becomes part of the email content. Many email clients sanitize, but you don’t rely on that.

  

We also convert message newlines **after** escaping:

```
escape first → then replace \n with <br/>
```

So <br/> stays real HTML, and user input stays safe text.

---

### **D) Subject header injection protection**

  

Email subject is a header, not HTML. We strip CR/LF:

```
input.fullName.replace(/[\r\n]+/g, " ")
```

**Why**

Prevents someone injecting extra headers by including newlines in their name.

---

## **Tests we added and what they prove**

  

**Test file:** (your Vitest file)

  

### **What is mocked**

- We **mock the Resend SDK**, so tests don’t send real emails.
    
- We assert what payload would have been sent.
    

  

### **What is tested**

1. **Sends email + escapes user input**
    

  

- Confirms to, from, replyTo, subject are correct
    
- Confirms HTML contains escaped versions (&lt;script&gt;) and not raw `<script>`
    

  

2. **Throws if** **RESEND_API_KEY** **missing**
    

  

- Ensures you fail fast and don’t attempt sending.
    

  

3. **Throws if** **INFO_PACK_TO_EMAIL** **missing**
    

  

- Ensures you can’t accidentally deploy with nowhere to send leads.
    

  

4. **Fallback reply-to**
    

  

- If input email is empty, uses INFO_PACK_REPLY_TO.
    

  

5. **Subject newline stripping**
    

  

- Confirms Alice\nBob becomes Alice Bob, no header injection.
    

  

### **Why the env manipulation exists in tests**

  

The tests override import.meta.env (and process.env) so each test can simulate different deploy configs.

---

## **Manual test checklist (real send)**

1. Set env vars locally:
    

  

- .env / .env.local
    
- restart dev server
    

  

2. Submit the form normally:
    

  

- confirm you receive the email
    
- confirm Reply goes to the lead email
    

  

3. Quick security sanity test:
    

  

- submit a message containing `<script>` and confirm the email shows &lt;script&gt; (escaped) not real HTML tags
    

---

